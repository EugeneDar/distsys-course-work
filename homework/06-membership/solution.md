## Общая идея

Это алгоритм SWIM с модификацией на инкарнации.

## Описание

### Хранимые значения

1. Словарь из id в статусы
2. Флаг, что мы сейчас состоим в какой-то группе (нужен, чтобы игнорировать входящие сообщения, если вышли из группы)
3. Словарь из id в инкарнации
4. Локальный счетчик инкарнаций
5. Время начала последней фазы
6. Текущий подозреваемый
7. Флаг на получение подтверждение от текущего подозреваемого

### Локальные сообщения

#### LOCAL JOIN

Обновляем локальный состав группы, если нужно отправляем JOIN участнику группы, ставим таймер. 

#### LOCAL LEAVE

Удаляем все таймеры, ставим флаг, что мы вне группы, очищаем состав группы.

#### LOCAL GET MEMBERSHIP

Возвращаем себя и всех участников группы, кроме тех, которые признаны упавшими.

### Сообщения

Игнорируем любое сообщение, если мы сейчас не в группе.

#### JOIN

Ставим себе локально пришедший процесс как живой. 

Отравляем PING_REQ случайным процессам,
так как таким образом эти случайные процессы добавят этот процесс в свой список,
а он добавит их (оптимизация для ускорения вхождения в группу).

#### PING

Применяем информацию из мультикаста. Отправляем ACK.

#### PING_REQ

Применяем информацию из мультикаста. Отправляем PING подозреваемому.

#### ACK

Если этот ACK предназначался нам, то обозначаем процесс как больше не подозреваемый.

Если мы получили этот ACK от процесса, который нас просили проверить, то отправляем ACK просителю.

### Таймер

#### Первая фаза

Если сейчас в группе нет никого кроме нас, то засыпаем еще раз.

Иначе отправляем PING случайному процессу, ставим таймер на вторую фазу.

#### Вторая фаза

Если проснулись раньше времени, которое мы отводим на время отправки сообщения туда и обратно, то засыпаем вновь (мера предосторожности).

Если нет подтверждения от процесса, то инициируем отравление случайных PING_REQ. Ставим таймер на третью фазу.

#### Третья фаза

Если проснулись раньше времени, которое мы отводим на время отправки сообщения туда и обратно, то засыпаем вновь (мера предосторожности).

Ставим статус подозреваемого в зависимости от того получили ли подтверждение от него. Ставим таймер на первую фазу.

### Вспомогательные функции

#### Создание информации для мультикаста

Берем себя и константное число случайных процессов в группе (в том числе тех, которые считаем отказавшими). 
Для каждого выбранного процесса возвращаем его инкарнацию и статус.

#### Применение информации из мультикаста

Проходимся по информации о каждом из переданных процессов. 

Если там информация о нас и она гласит, что мы мертвы, то увеличиваем свою локальную инкарнацию.

Если там информация о процессе, о котором мы ничего не знаем, то просто принимаем эту информацию.

Если в информации инкарнация равна локальной для данного процесса, то принимаем худший из статусов.

Если пришедшая инкарнация выше, то принимаем её статус.

#### Отправление случайного PING

Устанавливаем время начала фазы как текущее локальное время. Сбрасываем флаг получения подтверждения.
Выбираем случайный процесс и отправляем ей ACK.

#### Отравление случайных PING_REQ

Устанавливаем время начала фазы как текущее локальное время. Выбираем константное число случайных процессов и отравляем им PING_REQ.
